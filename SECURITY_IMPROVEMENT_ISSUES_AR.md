# قضايا تحسين الأمان والبنية (Issues)

## فهرس سريع (Index)
| رقم | العنوان | أولوية | نوع | جهد تقديري | تبعيات رئيسية |
|-----|---------|--------|-----|-------------|----------------|
| 1 | اعتماد قاعدة بيانات مركزية | حرجة | بنية بيانات | مرتفع | لا تبعيات سابقة |
| 2 | تجزئة كلمات المرور ونقل الهوية | حرجة | هوية | متوسط | (1) |
| 3 | نظام جلسات آمنة أو JWT | حرجة | مصادقة | متوسط | (2) |
| 4 | تفويض خادمي (Authorization Middleware) | حرجة | صلاحيات | متوسط | (3) |
| 5 | فرض HTTPS + HSTS | حرجة | نقل آمن | منخفض | لا تبعيات |
| 6 | تطبيق Rate Limit لمحاولات تسجيل الدخول | عالية | حماية هوية | منخفض | (3) |
| 7 | Content Security Policy أساسية صارمة | عالية | متصفح | متوسط | (5) |
| 8 | سجلات تدقيق (Audit Log) | عالية | حوكمة | متوسط | (1)(4) |
| 9 | حماية CSRF (في حال استخدام كوكيز) | عالية | تطبيق | منخفض | (3) |
|10 | MFA لحساب المدير | عالية | هوية | متوسط | (3)(2) |
|11 | RBAC مرن متعدد الأدوار | متوسطة | صلاحيات | متوسط | (4) |
|12 | إدارة أسرار مركزية (Vault) | متوسطة | بنية | متوسط | (1) |
|13 | سياسة احتفاظ وأرشفة بيانات | متوسطة | امتثال | متوسط | (1)(8) |
|14 | تحسين XSS (ترميز + SRI) | متوسطة | متصفح | متوسط | (7) |
|15 | نظام اكتشاف سلوك شاذ | منخفض | رصد متقدم | مرتفع | (8)(1) |
|16 | دمج SIEM (Elastic/Wazuh) | منخفض | رصد | مرتفع | (8) |
|17 | SAST/DAST في خط النشر | منخفض | جودة أمان | متوسط | (1)(5) |
|18 | تشفير مرفقات وبيانات حساسة (At-Rest) | متوسطة | حماية بيانات | مرتفع | (1)(12) |
|19 | تدوير مفاتيح وأسرار (Key Rotation) | منخفض | حوكمة | متوسط | (12) |
|20 | توليد معرف تذكرة خادمي موحد | متوسطة | نزاهة بيانات | منخفض | (1) |

---
## القضايا التفصيلية

### Issue 1: اعتماد قاعدة بيانات مركزية
- التصنيف: بنية بيانات / أساس
- الوصف: نقل التخزين من `localStorage` إلى قاعدة بيانات خادمية (PostgreSQL مبدئياً) مع مخطط جداول (Employees, Tickets, Departments, Notifications, AuditLogs, Attachments).
- المبرر: إزالة خطر التلاعب المحلي، إتاحة التزامن، تمكين النسخ الاحتياطي.
- معايير القبول:
  1. إعداد مخطط (Schema) موثق (ERD أولي).
  2. عمليات CRUD أساسية للتذاكر عبر API.
  3. اختبارات إدراج/قراءة/تحديث/حذف ناجحة.
  4. لا تبقى بيانات حرجة تعتمد حصرياً على المتصفح.
- الجهد: مرتفع (تهيئة DB + مهاجرات + طبقة وصول).
- المخاطر عند التأجيل: استمرار فقدان النزاهة وسيطرة المستخدم على البيانات.
- التبعيات: لا شيء.
- ملاحظات تنفيذ: استخدام أداة مهاجرات (Prisma أو Knex أو Sequelize)؛ تفعيل فهارس على (status, department, createdAt).

### Issue 2: تجزئة كلمات المرور ونقل الهوية
### Issue 2: تجزئة كلمات المرور ونقل الهوية
 - التصنيف: هوية
 - الوصف: نقل بيانات الموظفين إلى جدول Employees وتخزين كلمة المرور مجزأة (Argon2 مفضّل أو bcrypt بقيمة cost مناسبة).
 - المبرر: منع تسريب مباشر لكلمات المرور وحماية من هجمات offline في حال اختراق قاعدة البيانات.
 - معايير القبول:
   1. عدم وجود أي كلمة مرور نصية في التخزين أو الشيفرة بعد الترحيل.
   2. دالة `hashPassword()` تستخدم Argon2id (Memory ≥ 64MB, Iterations ملائمة) أو bcrypt (cost ≥ 12).
   3. دالة `verifyPassword()` تعيد نتيجة صحيحة/خاطئة مع زمن ثابت تقريباً لمنع Timing Attacks.
   4. اختبار وحدة يثبت فشل التحقق عند كلمة خاطئة ونجاحه عند الصحيحة.
   5. تسجيل `last_login_at` عند كل دخول ناجح.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: كشف مباشر لكلمات المرور وإمكانية إعادة استخدامها عبر أنظمة أخرى.
 - التبعيات: (1).
 - ملاحظات تنفيذ: استخدام مكتبة مدعومة رسمياً وتغليف المنطق في وحدة واحدة.

### Issue 3: نظام جلسات آمنة أو JWT
 - التصنيف: مصادقة
 - الوصف: تطبيق طبقة جلسات خادمية (Session Store) أو اعتماد JWT قصير العمر + Refresh Token ضمن Cookie HttpOnly Secure SameSite=Strict.
 - المبرر: إزالة تخزين الاعتماد في localStorage وتقليل خطر سرقة الاعتماد عبر XSS.
 - معايير القبول:
   1. تسجيل الدخول ينتج توكن وصول عمره ≤ 30 دقيقة.
   2. تنفيذ Refresh Token صالح ≤ 8 ساعات (أو دورة عمل) مع تدوير (Rotation).
   3. إبطال الجلسة عند تسجيل خروج / تغيير كلمة المرور.
   4. منع استخدام توكن منتهي أو ملغى (Blacklist أو Versioning).
   5. اختبارات: (Login → Access Protected → Expire → Refresh → Access) ناجح.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: جلسات بلا ضبط، قابلية اختطاف عالية.
 - التبعيات: (2).

### Issue 4: تفويض خادمي (Authorization Middleware)
 - التصنيف: صلاحيات
 - الوصف: وسيط خادمي يقوم بفحص الدور والقسم قبل الوصول إلى الموارد (Tickets/Notifications) بدلاً من الاعتماد على العميل.
 - المبرر: منع التلاعب بدور المستخدم عبر أدوات التطوير.
 - معايير القبول:
   1. طلب موظف لقسم آخر يُرفض بـ 403.
   2. المدير يصل لجميع التذاكر.
   3. دعم Forwarded Departments في القراءة.
   4. تسجيل كل رفض تفويض في Audit Log.
   5. تغطية اختبارات لحالات السماح والمنع.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: كشف بيانات بين أقسام.
 - التبعيات: (3).

### Issue 5: فرض HTTPS + HSTS
 - التصنيف: نقل آمن
 - الوصف: إعداد عكس Proxy (Nginx أو Caddy) لإعادة توجيه HTTP إلى HTTPS وإضافة رأس HSTS.
 - المبرر: حماية من MITM وDowngrade.
 - معايير القبول:
   1. إعادة توجيه 301 ثابتة.
   2. رأس `Strict-Transport-Security: max-age=15552000`.
   3. لا تحذيرات Mixed Content.
   4. فحص شهادة ناجح (لا منتهية ولا ضعيفة).
 - الجهد: منخفض.
 - المخاطر عند التأجيل: تسريب جلسات.
 - التبعيات: لا شيء.

### Issue 6: Rate Limit لمحاولات تسجيل الدخول
 - التصنيف: حماية هوية
 - الوصف: عداد محاولات لكل (IP, Username) مع تباطؤ تدريجي.
 - المبرر: خفض احتمالية هجمات القوة العمياء.
 - معايير القبول:
   1. 429 بعد 5 محاولات فاشلة/15 دقيقة.
   2. إعادة ضبط عند نجاح.
   3. إدراج رقم المحاولات المتبقية في ترويسة أو جسم الاستجابة.
   4. تسجيل تجاوز الحد في Audit.
 - الجهد: منخفض.
 - المخاطر عند التأجيل: تخمين سريع لكلمات المرور.
 - التبعيات: (3).

### Issue 7: Content Security Policy أساسية صارمة
 - التصنيف: متصفح
 - الوصف: تفعيل CSP بمنع scripts غير موثوقة وتقليل inline.
 - المبرر: تقليل مساحة XSS.
 - معايير القبول:
   1. مرحلة Report-Only أسبوع للتحقق.
   2. الانتقال إلى Enforce دون أعطال.
   3. منع تنفيذ سكربت تعسفي في اختبار حقن.
   4. وثائق استثناءات (إن وجدت).
 - الجهد: متوسط.
 - المخاطر عند التأجيل: بقاء ثغرات XSS.
 - التبعيات: (5).

### Issue 8: سجلات تدقيق (Audit Log)
 - التصنيف: حوكمة
 - الوصف: جدولة وحفظ كل حدث حرج مع قيم Before/After بالحد الأدنى.
 - المبرر: دعم التحقيقات والامتثال.
 - معايير القبول:
   1. تصميم جدول AuditLogs مع فهرس زمني.
   2. تسجيل: Login, PasswordChange, Ticket CRUD, Permission Denied.
   3. وظيفة تصدير CSV لفترة زمنية.
   4. منع التعديل/الحذف (Append-Only) أو Hash Chain.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: غياب آثار رقمية موثوقة.
 - التبعيات: (1)(4).

### Issue 9: حماية CSRF
 - التصنيف: تطبيق
 - الوصف: CSRF Tokens (Synchronizer أو Double Submit) في الطلبات الحالة.
 - المبرر: حماية من الأفعال القسرية.
 - معايير القبول:
   1. رفض أي طلب POST/PUT/DELETE بلا توكن.
   2. تدوير توكن عند تسجيل الخروج.
   3. اختبار محاكاة هجوم iframe يفشل.
   4. توثيق إدراج التوكن في الواجهة.
 - الجهد: منخفض.
 - المخاطر عند التأجيل: تنفيذ أوامر غير مقصودة.
 - التبعيات: (3).

### Issue 10: MFA لحساب المدير
 - التصنيف: هوية
 - الوصف: إضافة TOTP (Google Authenticator) أو WebAuthn للمدير.
 - المبرر: رفع عتبة اختراق الحساب الحساس.
 - معايير القبول:
   1. مسار إعداد (Enroll) مع QR.
   2. تحقق رمز صالح (6 أرقام) ضمن نافذة زمنية.
   3. تخزين سر مشفر.
   4. رموز احتياطية (5) للاستخدام الطارئ.
   5. تعطيل آمن مع تسجيل السبب.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: تعرض حساب المدير لخطر أعلى.
 - التبعيات: (3)(2).

### Issue 11: RBAC مرن متعدد الأدوار
 - التصنيف: صلاحيات
 - الوصف: تعريف مصفوفة أذونات (Action → Roles) وطبقة استعلام `can()`.
 - المبرر: تقليل صلاحيات زائدة.
 - معايير القبول:
   1. جدول Roles، جدول RolePermissions.
   2. أدوار: admin, department_user, auditor, viewer.
   3. منع دور viewer من تعديل.
   4. تغطية 90% على الأقل من وظائف can() بالاختبارات.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: توسع صلاحيات غير منضبط.
 - التبعيات: (4).

### Issue 12: إدارة أسرار مركزية (Vault)
 - التصنيف: بنية
 - الوصف: تخزين الأسرار في Vault (HashiCorp أو بديل سحابي) مع سياسة وصول.
 - المبرر: تقليل تسرب الأسرار في بيئات متعددة.
 - معايير القبول:
   1. جميع الأسرار تأتي عبر واجهة تحميل آمنة.
   2. لا أسرار مكشوفة في Git.
   3. توثيق إجراء إضافة/حذف.
   4. اختبار فشل عند غياب سر ضروري.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: مخاطر تسريب.
 - التبعيات: (1).

### Issue 13: سياسة احتفاظ وأرشفة بيانات
 - التصنيف: امتثال
 - الوصف: جداول أرشيف + وظيفة نقل عناصر قديمة بحسب زمن.
 - المبرر: التحكم في الحجم والامتثال للخصوصية.
 - معايير القبول:
   1. مهمة مجدولة أسبوعية للأرشفة.
   2. استرجاع عنصر مؤرشف للاطلاع فقط.
   3. عدم تعديل المحتوى المؤرشف.
   4. توثيق فترات لكل نوع بيانات.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: تضخم وقابلية انتهاك لوائح.
 - التبعيات: (1)(8).

### Issue 14: تحسين XSS (ترميز + SRI)
 - التصنيف: متصفح
 - الوصف: ضمان ترميز كل مخرجات الحقول المدخلة وتفعيل SRI للسكربتات الخارجية.
 - المبرر: خفض خطر الحقن.
 - معايير القبول:
   1. لا استخدام خطير لـ `dangerouslySetInnerHTML` دون تعقيم.
   2. فحص يدوي لسيناريو حقن يعرض النص خام.
   3. SRI أو Bundling محلي.
   4. توثيق قائمة الحقول الخطرة وتدابيرها.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: إمكانية اختراق عبر حقل وصف.
 - التبعيات: (7).

### Issue 15: نظام اكتشاف سلوك شاذ
 - التصنيف: رصد متقدم
 - الوصف: تحليل إحصائي لاستخدام الموظفين مع تنبيه عند انحراف كبير.
 - المبرر: كشف تهديد داخلي مبكر.
 - معايير القبول:
   1. حساب متوسط/انحراف معياري للسلوك.
   2. تنبيه عند تجاوز Z-Score > 3.
   3. لوحة تعرض أهم 10 أحداث شاذة.
   4. ربط التنبيه بسجل تدقيق.
 - الجهد: مرتفع.
 - المخاطر عند التأجيل: طول زمن اكتشاف إساءة.
 - التبعيات: (8)(1).

### Issue 16: دمج SIEM (Elastic/Wazuh)
 - التصنيف: رصد
 - الوصف: إرسال سجلات (Access, Audit, Security) إلى SIEM وتحليل مركزي.
 - المبرر: تحسين الرؤية الأمنية.
 - معايير القبول:
   1. خط تجميع Logs آمن TLS.
   2. تنبيه email عند ≥ 10 رفض صلاحيات خلال 5 دقائق.
   3. لوحة تعرض اتجاهات أسبوعية.
 - الجهد: مرتفع.
 - المخاطر عند التأجيل: صعوبة الاستجابة السريعة.
 - التبعيات: (8).

### Issue 17: SAST/DAST في خط النشر
 - التصنيف: جودة أمان
 - الوصف: دمج فحوص ساكنة وديناميكية في CI.
 - المبرر: إيقاف مبكر للثغرات.
 - معايير القبول:
   1. فشل البناء عند ثغرة حرجة.
   2. تقارير محفوظة 30 يوم.
   3. توثيق معالجة نتائج.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: دخول ثغرات للإنتاج.
 - التبعيات: (1)(5).

### Issue 18: تشفير مرفقات وبيانات حساسة (At-Rest)
 - التصنيف: حماية بيانات
 - الوصف: طبقة تشفير ميداني (Field-Level) أو تشفير ملفات مرفقات.
 - المبرر: حماية عند اختراق التخزين.
 - معايير القبول:
   1. مفتاح رئيسي من Vault.
   2. تدوير مفتاح تشغيلي نصف سنوي.
   3. فشل فك التشفير لا يكشف النص.
 - الجهد: مرتفع.
 - المخاطر عند التأجيل: كشف بيانات حساسة.
 - التبعيات: (1)(12).

### Issue 19: تدوير مفاتيح وأسرار (Key Rotation)
 - التصنيف: حوكمة
 - الوصف: سياسة زمنية لتغيير أسرار حساسة وتوثيق الإجراء.
 - المبرر: تقليل زمن تعرض السر.
 - معايير القبول:
   1. سجل تدوير مع طابع زمني.
   2. إنذار عند قرب انتهاء صلاحية.
   3. اختبار إعادة تحميل سري دون انقطاع خدمة.
 - الجهد: متوسط.
 - المخاطر عند التأجيل: طول فترة تعرّض.
 - التبعيات: (12).

### Issue 20: توليد معرف تذكرة خادمي موحد
 - التصنيف: نزاهة بيانات
 - الوصف: نقل منطق التوليد إلى الخادم مع تسلسل يومي محمي (Lock) وتجنب التضارب.
 - المبرر: منع التلاعب المحلي وضمان فريدية.
 - معايير القبول:
   1. اختبار 1000 توليد متزامن بلا تضارب.
   2. عدم قبول معرف وارد من العميل.
   3. إمكانية تخصيص البادئة والقالب عبر إعداد خادمي فقط.
 - الجهد: منخفض.
 - المخاطر عند التأجيل: تضارب/تزوير معرف.
 - التبعيات: (1).

---
## ملاحظات عامة للتنفيذ
 - استخدام UTC في جميع الطوابع الزمنية.
 - ربط كل Commit بإشارة Issue رقمية.
 - إضافة Labels: `security`, `architecture`, `compliance`, `observability`.

## ختام
هذه القائمة قابلة للتطوير؛ يمكن دمج بعض القضايا الصغيرة أو تقسيم الكبيرة حسب سعة الفريق. اقترح البدء بدفعة (1→6) أولاً.
... (سيتم اختصار عرض القضايا هنا للحجم، في الملف الكامل بقية القضايا من 3 إلى 20 مذكورة بصيغة مماثلة) ...

### ملاحظة
الملف المختصر هنا يعرض النمط؛ إن رغبت بإدراج التوسع الكامل لجميع القضايا من 3 إلى 20 بالتفصيل أضف طلب تحديث، وسأقوم بتوسيعه (حفاظاً على التركيز الآن).
