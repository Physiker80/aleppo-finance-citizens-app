# تقرير البنية المعمارية والأمان

## 1. الملخص التنفيذي
نظام "الاستعلامات والشكاوى لمديرية مالية حلب" هو تطبيق أحادي الصفحة (SPA) مبني على React + Vite + TypeScript، يعتمد كلياً في نسخته الحالية على التخزين المحلي للمتصفح (localStorage) لتخزين البيانات التشغيلية (تذاكر، موظفون، رسائل، إشعارات)، مع خادم Node/Express مساعد يوفّر طبقة مراقبة (مقاييس، أخطاء، تتبع IP، تلخيص ذكي) وبعض الخدمات (بريد إلكتروني، تتبع اختياري). التركيز الحالي قوي في جانب الرصد (Observability) لكنه ضعيف في جوانب الأمن المؤسسية (المصادقة، التفويض الخادمي، حماية البيانات، التتبع الجنائي). هذا التقرير يصف البنية، يقيم الوضع الأمني، ويضع خارطة طريق للتحسين.

## 2. نظرة عامة معمارية
### 2.1 المكونات الرئيسية
- **الواجهة (Frontend)**: React SPA مع توجيه عبر `window.location.hash` بدون مكتبة حالة خارجية (استخدام Context فقط).
- **التخزين**: `localStorage` و `sessionStorage` لحفظ جميع الكيانات (لا قاعدة بيانات مركزية حالياً).
- **الخادم (Backend)**: ملف واحد رئيسي `server.js` يقدّم: Express middlewares، معدلات طلب، CORS مقيد، Helmet، مقاييس Prometheus، ملخص مقاييس، إدارة أخطاء، تتبع IP، إرسال بريد، تحليل مراقبة ذكي، دعم اختياري OpenTelemetry/Sentry/Elastic.
- **المراقبة (Observability)**: صفحة متابعة (ObservabilityPage) + Metrics Summary + Error Store + Render/Reload Diagnostics.
- **توليد المعرفات**: عبر `utils/idGenerator.ts` بنمط قابل للتخصيص باستخدام قوالب محفوظة في التخزين المحلي.

### 2.2 الطبقات المنطقية
1. طبقة العرض (UI Components & Pages)
2. طبقة الحالة (AppContext + Hooks)
3. طبقة المرافق (Utilities: توليد معرفات، تحليلات، أقسام، قوالب)
4. طبقة الخدمات الخادمية (Endpoints للمقاييس، الأخطاء، البريد، التحليل)
5. طبقة الرصد والتحليلات (Prometheus + Summaries + Tracing اختياري)

### 2.3 تدفق بيانات التذكرة (نموذج)
مواطن يقدّم تذكرة → توليد معرف → حفظ محلي (ticket) → إشعار القسم → معالجة الموظف (تغيير حالات) → رد/إغلاق → إمكانية تصدير PDF وQR → تبقى البيانات محلياً في المتصفح الحالي.

### 2.4 القيود الحالية
- لا مزامنة بين أجهزة أو مستخدمين (كل متصفح جزيرة بيانات).
- لا تحكم صلاحيات خادمي حقيقي (التحقق يتم على العميل فقط).
- لا إستراتيجية نسخ احتياطي أو أرشفة تاريخية.

## 3. إدارة الهوية والصلاحيات
- الأدوار: `مدير` و `موظف` فقط.
- التحقق من الوصول (Authorization) يتم في الواجهة: دالة `canAccessTicket()`.
- كلمات مرور الموظفين محفوظة بنص صريح في `localStorage`.
- لا يوجد: تجزئة، قفل حساب، انتهاء جلسة، سياسات تعقيد، MFA، سجل تدقيق تغييرات.

## 4. المراقبة والرصد
- مقاييس: عدادات، هيستوغرام زمن الاستجابة، مؤشرات مشتقة.
- Endpoint تلخيص: `/api/metrics-summary` يحسب Quantiles، أعلى المسارات، أخطاء متكررة.
- إدارة انفجار البطاقات: Allowlist للمسارات وعناوين IP.
- أدوات تشخيص داخلية: مراقبة إعادة التصيير، سجل محاولات إعادة التحميل، تحليل ذكي.

## 5. طبقة الأمان الحالية (مزايا)
1. Helmet لترويسات أمان (CSP معطّل في التطوير).
2. CORS محدود لنطاقات محددة.
3. معدل طلبات (عام + بريد + مسارات حساسة).
4. مفاتيح API لبعض الموارد (Metrics / Admin-like).
5. Sanitization لـ HTML البريد (`sanitize-html`).
6. تتبع IP مع تقليم بيانات قديمة.
7. منع انفجار المقاييس عبر Allowlist.
8. رصد غني (Metrics + Errors + Summaries + Tracing اختياري).
9. بساطة الخادم (سطح هجوم أصغر نسبياً).

## 6. المخاطر والثغرات
| المجال | المخاطرة | الأثر | مستوى الخطورة |
|--------|----------|-------|----------------|
| المصادقة | كلمات مرور نص صريح | استيلاء فوري عند اختراق متصفح | حرج |
| التفويض | تحقق عميل فقط | تعديل/وصول غير مصرّح | حرج |
| التخزين | كل البيانات في localStorage | تعديل/قراءة عبر XSS | حرج |
| جلسات | لا انتهاء/تجديد | اختطاف جلسات طويل | عالٍ |
| النقل | غياب توثيق فرض HTTPS | MITM محتمل | عالٍ |
| XSS | عدم وجود CSP صارمة | تنفيذ سكربت ضار | عالٍ |
| CSRF | لا حماية مخصصة | تنفيذ أفعال قسرية | متوسط/عالٍ |
| التدقيق | لا Audit مركزي | ضعف التحقيق بعد حادث | متوسط |
| الأسرار | إدارة بسيطة للمتغيرات | تسريب/دوران ضعيف | متوسط |
| النسخ الاحتياطي | لا قاعدة مركزية | فقدان دائم للبيانات | متوسط |
| القوة العمياء | لا Lockout | تخمين كلمات مرور | متوسط |
| سلامة البيانات | لا توقيع/Hash داخلي | تلاعب صامت | متوسط |
| البريد | Sanitization فقط | تجاوزات مركبة نادرة | منخفض/متوسط |

## 7. تقييم نضج أمني (تقريبي)
- الهوية والصلاحيات: 1/5
- حماية البيانات: 2/5
- الرصد والكشف: 3.5/5
- الاستجابة للحوادث: 2/5
- الحوكمة والامتثال: 1.5/5
- الدفاع المتعدد الطبقات: 2/5

## 8. ملخص المزايا والعيوب
### المزايا
- رصد متقدم مقارنة بنضج بقية الجوانب.
- بساطة خادم تقلل تعقيد الثغرات.
- أدوات تشخيص ديناميكية مدمجة.
- الحماية من انفجار المقاييس.
- إمكانية تفعيل التتبع عند الطلب.

### العيوب
- غياب نموذج مصادقة وإدارة هوية مؤسسي.
- اعتماد كامل على ثقة العميل.
- لا تشفير ولا تجزئة للبيانات الحساسة.
- هشاشة أمام XSS وSession Hijacking.

## 9. التوصيات حسب الأولوية
### 9.1 عاجلة (0–2 أسابيع)
1. نقل بيانات الموظفين والتذاكر إلى قاعدة بيانات خادمية (PostgreSQL/SQLite مبدئياً).
2. تجزئة كلمات المرور (Argon2 أو bcrypt) + سياسات تعقيد.
3. إنشاء طبقة مصادقة (Sessions آمنة أو JWT + Cookies HttpOnly/Secure/SameSite=Strict).
4. طبقة تفويض خادمية تعتمد الدور والقسم.
5. فرض HTTPS + HSTS.
6. معدل محاولات تسجيل دخول + Lockout مرحلي.
7. Content Security Policy مبدئية (حظر inline scripts حيث ممكن).
8. Audit Log (عمليات إنشاء/تعديل/إغلاق التذاكر).

### 9.2 متوسطة (2–6 أسابيع)
1. RBAC مرن (مدير، مراقب، موظف قسم، مدقق، دعم فني).
2. إدارة أسرار (Vault / Docker secrets).
3. تقوية XSS عبر ترميز المخرجات + Subresource Integrity.
4. حماية CSRF (Tokens أو Double Submit) إذا استخدمت كوكيز.
5. سياسات احتفاظ بيانات (Retention & Archiving).
6. إضافة MFA لحساب المدير.

### 9.3 طويلة (6–16 أسبوع)
1. Zero-Trust داخلي (كل طلب موقّع ومفوّض).
2. تكامل SIEM (Elastic / Wazuh) + تنبيهات زمن حقيقي.
3. تشفير عند الراحة (ملفات، مرفقات) باستخدام KMS.
4. كشف سلوك شاذ (تحليل نمطي لقراءة تذاكر).
5. SAST/DAST في خط النشر (Semgrep, OWASP ZAP).
6. دوران مفاتيح (Key Rotation) دوري.

## 10. خارطة حالة مستهدفة
- **واجهة**: تعتمد على API آمنة، تقلل المنطق الحساس داخل المتصفح.
- **خادم**: مسؤول مركزي عن الهوية، التفويض، التدقيق، السياسات.
- **بيانات**: مخطط منظم + فهارس + نسخ احتياطي مجدول.
- **أمن**: جلسات قصيرة + Refresh Tokens + MFA + مراقبة سلوك.
- **رصد**: دمج المقاييس الحالية مع Grafana رسمية ولوحات KPI.

## 11. توليد معرف التذكرة
- النمط الافتراضي: `ALF-YYYYMMDD-RAND6`.
- القابلية للتخصيص عبر مفتاح `ticketIdConfig`.
- التسلسل يومي ويعاد ضبطه آلياً.
- مستقبلاً: التوليد من الخادم لضمان اتساق عالمي.

## 12. مفاتيح التخزين المحلي (أمثلة)
`tickets`, `employees`, `contactMessages`, `notifications`, `departmentsList`, `render_events_observability`, `reload_guard_events`, `manualTicketId`, `ticketIdConfig`.
- المخاطرة: قابلية التلاعب اليدوي بكامل دورة حياة التذاكر.

## 13. سيناريوهات تهديد مختصرة
| السيناريو | الوصف | الإجراء الوقائي |
|----------|-------|------------------|
| تعديل تذكرة | تغيير الحقول محلياً | تفويض خادمي + توقيع استجابة |
| هجوم XSS | إدخال حقل وصف ضار | CSP + ترميز + تحقق خادمي |
| اختطاف جلسة | سرقة Cookie | جلسات قصيرة + تجديد + ربط IP/UA |
| تخمين كلمة مرور | محاولات متكررة | Lockout + MFA + Rate Limit |
| رفع صلاحيات | تعديل role محلياً | تجاهل role العميل واعتماد الخادم |

## 14. خطة تنفيذ Sprint مبدئية
- Sprint 1: DB + Auth + Password Hashing + HTTPS.
- Sprint 2: Authorization Middleware + Audit Log + CSP.
- Sprint 3: MFA + CSRF + RBAC + Retention Policies.
- Sprint 4: SIEM + SAST/DAST + Key Rotation + Anomaly Detection.

## 15. مؤشرات الأداء الأمنية (KPIs)
- P95 زمن استجابة API < 400ms.
- 0% تذاكر معدّلة بدون سجل تدقيق.
- ≥95% اكتشاف محاولات دخول فاشلة عالية الخطورة.
- اكتمال سجلات التدقيق ≥ 98% للعمليات الحرجة.
- MTTR (زمن حل حادث) < 4 ساعات للحوادث المتوسطة.

## 16. الخلاصة
يمتلك النظام قاعدة رصد قوية لكنه يحتاج انتقالاً عاجلاً من نموذج "ثقة العميل" إلى نموذج "سلطة الخادم" مع طبقات مصادقة وتفويض وتخزين مركزي وتطبيق دفاع متعدد المستويات. اتباع خارطة الطريق المقترحة سيرفع النضج الأمني ويحسّن الثقة والاستمرارية التشغيلية.

## 17. ملاحق مستقبلية (اختيارية للتوسعة)
- نسخة إنجليزية مختصرة للتواصل الدولي.
- دمج مع هوية حكومية (SSO / PKI) عند توفر المتطلبات.
- سياسة تصنيف بيانات رسمية (Public / Internal / Confidential / Restricted).

---
تم إعداد هذا التقرير اعتماداً على قراءة ملفات: `server.js`, `types.ts`, `utils/idGenerator.ts` وحالة الواجهة الحالية.
