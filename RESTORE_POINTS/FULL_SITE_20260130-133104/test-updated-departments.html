<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙƒÙˆÙ† Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ù…Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #0f3c35 0%, #1a5752 100%);
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-results {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .btn {
            background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 70, 229, 0.4);
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù…ÙƒÙˆÙ† Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ù…Ø¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©</h1>
            <p>Ø§Ø®ØªØ¨Ø§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙƒÙˆÙ† Ù„ÙŠØ³ØªØ®Ø¯Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</p>
        </div>

        <div class="test-results">
            <h2>ğŸ“‹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
            <div id="testResults">
                <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</p>
            </div>
            
            <button class="btn" onclick="runTests()">ğŸ”¬ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
            <button class="btn" onclick="setupTestData()">ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
            <button class="btn" onclick="clearTestData()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
        </div>

        <div class="test-results">
            <h2>ğŸ”— Ø±ÙˆØ§Ø¨Ø· Ø³Ø±ÙŠØ¹Ø©</h2>
            <button class="btn" onclick="window.open('/test-departments.html', '_blank')">ğŸ›ï¸ ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
            <button class="btn" onclick="window.open('/test-detailed-report.html', '_blank')">ğŸ“Š ØµÙØ­Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙØµÙ„</button>
            <button class="btn" onclick="window.open('/#/message-analytics', '_blank')">ğŸ“ˆ ØµÙØ­Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</button>
        </div>
    </div>

    <script>
        let testResults = [];

        // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© Ù…Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
        const expectedDepartments = [
            'Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©',
            'Ù‚Ø³Ù… Ø§Ù„Ø¯Ø®Ù„',
            'Ù‚Ø³Ù… ÙƒØ¨Ø§Ø± ÙˆÙ…ØªÙˆØ³Ø·ÙŠ Ø§Ù„Ù…ÙƒÙ„ÙÙŠÙ†', 
            'Ù‚Ø³Ù… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆÙ†',
            'Ù‚Ø³Ù… Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª',
            'Ù‚Ø³Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©',
            'Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠØ©',
            'Ù‚Ø³Ù… Ø§Ù„ØªÙ†Ù…ÙŠØ© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©',
            'Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…',
            'Ù‚Ø³Ù… Ø§Ù„Ø®Ø²ÙŠÙ†Ø©'
        ];

        function addTestResult(test, status, message) {
            testResults.push({ test, status, message });
        }

        function displayResults() {
            const container = document.getElementById('testResults');
            let html = '<h3>ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª:</h3><ul>';
            
            testResults.forEach((result, index) => {
                const statusClass = result.status === 'success' ? 'success' : 'error';
                const statusIcon = result.status === 'success' ? 'âœ…' : 'âŒ';
                html += `<li class="${statusClass}">
                    ${statusIcon} <strong>${result.test}:</strong> ${result.message}
                </li>`;
            });
            
            html += '</ul>';
            
            const successCount = testResults.filter(r => r.status === 'success').length;
            const totalCount = testResults.length;
            
            html += `<div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <strong>Ø§Ù„Ù…Ù„Ø®Øµ:</strong> ${successCount}/${totalCount} Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¬Ø­
                ${successCount === totalCount ? ' ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª!' : ''}
            </div>`;
            
            container.innerHTML = html;
        }

        function runTests() {
            testResults = [];
            
            // Ø§Ø®ØªØ¨Ø§Ø± 1: ÙØ­Øµ ÙˆØ¬ÙˆØ¯ localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                addTestResult('LocalStorage', 'success', 'Ù…ØªØ§Ø­ ÙˆÙŠØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
            } catch (error) {
                addTestResult('LocalStorage', 'error', 'ØºÙŠØ± Ù…ØªØ§Ø­ Ø£Ùˆ Ù„Ø§ ÙŠØ¹Ù…Ù„');
            }

            // Ø§Ø®ØªØ¨Ø§Ø± 2: ÙØ­Øµ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ localStorage
            const storedDepts = localStorage.getItem('departmentsList');
            if (storedDepts) {
                try {
                    const depts = JSON.parse(storedDepts);
                    if (Array.isArray(depts) && depts.length > 0) {
                        addTestResult('Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', 'success', `Ù…ÙˆØ¬ÙˆØ¯ ${depts.length} Ù‚Ø³Ù…Ø§Ù‹ ÙÙŠ localStorage`);
                    } else {
                        addTestResult('Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', 'error', 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    }
                } catch (error) {
                    addTestResult('Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', 'error', 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù…');
                }
            } else {
                addTestResult('Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©', 'error', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…Ø­ÙÙˆØ¸Ø©');
            }

            // Ø§Ø®ØªØ¨Ø§Ø± 3: ÙØ­Øµ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©
            const storedMessages = localStorage.getItem('internalMessages');
            if (storedMessages) {
                try {
                    const messages = JSON.parse(storedMessages);
                    if (Array.isArray(messages) && messages.length > 0) {
                        addTestResult('Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', 'success', `Ù…ÙˆØ¬ÙˆØ¯ ${messages.length} Ø±Ø³Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ©`);
                        
                        // ÙØ­Øµ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                        const messageDepts = [...new Set(messages.flatMap(msg => [
                            msg.from.includes('Ø§Ù„Ø¯ÙŠÙˆØ§Ù†') ? null : msg.from,
                            msg.to.includes('Ø§Ù„Ø¯ÙŠÙˆØ§Ù†') ? null : msg.to
                        ]).filter(Boolean))];
                        
                        const usingNewDepts = messageDepts.some(dept => expectedDepartments.includes(dept));
                        if (usingNewDepts) {
                            addTestResult('Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©', 'success', `Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ³ØªØ®Ø¯Ù… Ø£Ù‚Ø³Ø§Ù… Ù…Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ`);
                        } else {
                            addTestResult('Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©', 'error', `Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø©`);
                        }
                    } else {
                        addTestResult('Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', 'error', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¯Ø§Ø®Ù„ÙŠØ©');
                    }
                } catch (error) {
                    addTestResult('Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', 'error', 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„');
                }
            } else {
                addTestResult('Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©', 'error', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø­ÙÙˆØ¸Ø©');
            }

            // Ø§Ø®ØªØ¨Ø§Ø± 4: ÙØ­Øµ ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            if (storedDepts && storedMessages) {
                try {
                    const depts = JSON.parse(storedDepts);
                    const messages = JSON.parse(storedMessages);
                    
                    let dataIntegrityOk = true;
                    messages.forEach(msg => {
                        if (!msg.id || !msg.from || !msg.to || !msg.direction) {
                            dataIntegrityOk = false;
                        }
                    });

                    if (dataIntegrityOk) {
                        addTestResult('ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'success', 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                    } else {
                        addTestResult('ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error', 'Ø¨Ø¹Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªÙØªÙ‚Ø± Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                    }
                } catch (error) {
                    addTestResult('ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error', 'Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
            }

            displayResults();
        }

        function setupTestData() {
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            const departments = expectedDepartments.map(name => ({ name }));
            localStorage.setItem('departmentsList', JSON.stringify(departments));
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©
            const messages = [];
            for (let i = 0; i < 10; i++) {
                const dept = expectedDepartments[Math.floor(Math.random() * expectedDepartments.length)];
                const isFromDiwan = Math.random() > 0.5;
                const sentDate = new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000);
                
                messages.push({
                    id: `test_${Date.now()}_${i}`,
                    from: isFromDiwan ? 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ø¹Ø§Ù…' : dept,
                    to: isFromDiwan ? dept : 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ø¹Ø§Ù…', 
                    subject: `Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø³Ø§Ù„Ø© ${i + 1}`,
                    content: `Ù…Ø­ØªÙˆÙ‰ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø±Ø³Ø§Ù„Ø© Ø±Ù‚Ù… ${i + 1}`,
                    priority: ['Ø¹Ø§Ø¬Ù„', 'Ù‡Ø§Ù…', 'Ø¹Ø§Ø¯ÙŠ'][Math.floor(Math.random() * 3)],
                    status: ['Ù…Ø±Ø³Ù„', 'Ù…Ø³ØªÙ„Ù…', 'Ù‚ÙŠØ¯_Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ù…Ø¬Ø§Ø¨'][Math.floor(Math.random() * 4)],
                    sentAt: sentDate.toISOString(),
                    direction: isFromDiwan ? 'Ù…Ù†_Ø§Ù„Ø¯ÙŠÙˆØ§Ù†' : 'Ø¥Ù„Ù‰_Ø§Ù„Ø¯ÙŠÙˆØ§Ù†'
                });
            }
            localStorage.setItem('internalMessages', JSON.stringify(messages));
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø­Ø¯Ø« ØªØ­Ø¯ÙŠØ«
            window.dispatchEvent(new Event('departmentsListUpdated'));
            
            alert(`âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\n\n- ${departments.length} Ù‚Ø³Ù…Ø§Ù‹\n- ${messages.length} Ø±Ø³Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ©`);
        }

        function clearTestData() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©ØŸ')) {
                localStorage.removeItem('departmentsList');
                localStorage.removeItem('internalMessages');
                window.dispatchEvent(new Event('departmentsListUpdated'));
                alert('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ©');
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.getElementById('testResults').innerHTML = '<p class="info">ğŸ’¡ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª" Ù„ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</p>';
            }, 500);
        });
    </script>
</body>
</html>