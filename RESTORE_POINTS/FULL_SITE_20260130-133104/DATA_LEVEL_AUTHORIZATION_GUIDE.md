# دليل نظام التفويض على مستوى البيانات - Data Level Authorization Guide

## نظرة عامة
نظام التفويض على مستوى البيانات (Data-Level Authorization System) هو نظام شامل يتحكم في الوصول للبيانات بناءً على:
- **مستوى التصنيف الأمني للبيانات** (Data Classification Level)
- **صلاحيات المستخدم** (User Permissions)
- **قواعد التحكم في الوصول المعتمدة على السمات** (Attribute-Based Access Control - ABAC)

## مستويات التصنيف الأمني

### 1. عام (Public)
- **الوصف**: معلومات متاحة للجمهور
- **مثال**: الأسئلة الشائعة، الإعلانات العامة
- **من يستطيع الوصول**: جميع المستخدمين

### 2. داخلي (Internal)
- **الوصف**: معلومات للاستخدام الداخلي للمؤسسة
- **مثال**: معظم تذاكر الاستعلامات، المراسلات الداخلية
- **من يستطيع الوصول**: الموظفون فقط

### 3. سري (Confidential)
- **الوصف**: معلومات حساسة تتطلب صلاحيات خاصة
- **مثال**: البيانات المالية، معلومات الرواتب، البيانات الضريبية
- **من يستطيع الوصول**: الموظفون المخولون في الأقسام المختصة

### 4. سري للغاية (Highly Confidential)
- **الوصف**: معلومات عالية السرية
- **مثال**: التحقيقات القانونية، قضايا الفساد، التقارير الأمنية
- **من يستطيع الوصول**: المديرون وكبار المسؤولين فقط

## العمليات المدعومة

### 1. القراءة (READ)
- عرض البيانات دون تعديل
- الأكثر شيوعاً في النظام

### 2. التحديث (UPDATE)
- تعديل البيانات الموجودة
- تتطلب صلاحيات أعلى من القراءة

### 3. الحذف (DELETE)
- حذف البيانات نهائياً
- أعلى مستوى من الصلاحيات

### 4. التصدير (EXPORT)
- تصدير البيانات لملفات خارجية
- تحكم خاص لمنع تسريب البيانات

### 5. الأرشفة (ARCHIVE)
- أرشفة البيانات للحفظ طويل المدى
- صلاحيات إدارية

## الملفات الرئيسية

### 1. `utils/dataLevelAuthorization.ts`
الملف الأساسي الذي يحتوي على:
- تعريف مستويات التصنيف الأمني
- قواعد التحكم في الوصول
- محرك التفويض الأساسي

### 2. `utils/dataAuthIntegration.ts`
ملف التكامل مع النظام الحالي:
- تحويل بيانات النظام للصيغة المصنفة أمنياً
- Hook للاستخدام في React Components
- دوال مساعدة للفحص السريع

### 3. `pages/SecureRequestsPage.tsx`
مثال تطبيقي كامل يوضح:
- كيفية استخدام نظام التفويض في الواجهات
- عرض الصلاحيات للمستخدم
- تطبيق القيود على العمليات

## كيفية الاستخدام

### 1. استيراد النظام
```typescript
import { useDataLevelAuthorization } from '../utils/dataAuthIntegration';
import { DataOperation } from '../utils/dataLevelAuthorization';
```

### 2. استخدام Hook في Component
```typescript
const MyComponent: React.FC = () => {
  const dataAuth = useDataLevelAuthorization();
  const { currentEmployee, tickets } = useContext(AppContext);
  
  // تصفية التذاكر حسب الصلاحيات
  const accessibleTickets = dataAuth.filterTicketsByAccess(tickets, currentEmployee);
  
  // فحص صلاحية معينة
  const canEdit = dataAuth.canEditTicket(ticket, currentEmployee);
  
  return (
    // واجهة المستخدم
  );
};
```

### 3. فحص الصلاحيات قبل العمليات
```typescript
// قبل عرض البيانات
if (dataAuth.checkTicketAccess(ticket, employee, DataOperation.READ)) {
  // عرض التذكرة
}

// قبل التحرير
if (dataAuth.canEditTicket(ticket, employee)) {
  // فتح نموذج التحرير
}

// قبل الحذف
if (dataAuth.canDeleteTicket(ticket, employee)) {
  // تنفيذ عملية الحذف
}
```

## قواعد التفويض الافتراضية

### للتذاكر (Tickets)
- **عام**: يمكن لجميع الموظفين قراءتها
- **داخلي**: الموظفون في نفس القسم أو المحول إليهم
- **سري**: المشرفون والمديرون في الأقسام المختصة
- **سري للغاية**: المديرون فقط

### للوثائق (Documents)
- **عام**: قراءة عامة، تحديث للمالك
- **داخلي**: قراءة للقسم، تحديث للمالك
- **سري**: صلاحيات محدودة للمشرفين
- **سري للغاية**: المديرون فقط

### للرسائل (Messages)
- **عام**: متاحة لجميع الموظفين
- **داخلي**: للأقسام المعنية
- **سري**: للمشرفين والمديرين
- **سري للغاية**: للمديرين فقط

### للموظفين (Employees)
- **عام**: المعلومات الأساسية
- **داخلي**: معلومات الاتصال والقسم
- **سري**: التفاصيل المالية
- **سري للغاية**: المعلومات الحساسة

### للتقارير (Reports)
- **عام**: تقارير عامة
- **داخلي**: تقارير القسم
- **سري**: التقارير المالية
- **سري للغاية**: تقارير التدقيق

## التدقيق والسجلات

### تسجيل محاولات الوصول
النظام يسجل تلقائياً:
- من حاول الوصول
- ماذا حاول الوصول إليه
- نوع العملية
- نتيجة المحاولة (نجح/فشل)
- السبب في حالة الفشل
- وقت المحاولة

### استعراض السجلات
```typescript
import { getDataAccessLogs } from '../utils/dataAuthIntegration';

// جميع السجلات
const allLogs = getDataAccessLogs();

// سجلات موظف معين
const employeeLogs = getDataAccessLogs({ 
  employee: 'admin' 
});

// سجلات نوع عملية معين
const readLogs = getDataAccessLogs({ 
  operation: DataOperation.READ 
});

// سجلات فترة زمنية
const recentLogs = getDataAccessLogs({
  from: new Date('2024-01-01'),
  to: new Date()
});
```

## التخصيص والتوسع

### إضافة مستوى تصنيف جديد
```typescript
// في dataLevelAuthorization.ts
export enum DataClassificationLevel {
  // المستويات الموجودة...
  TOP_SECRET = 'سري جداً' // مستوى جديد
}

// إضافة قواعد للمستوى الجديد في accessRules
```

### إضافة نوع موارد جديد
```typescript
// إضافة نوع جديد
const newResourceRules = {
  'new-resource': {
    [DataClassificationLevel.PUBLIC]: {
      [DataOperation.READ]: (user, data) => true,
      // باقي العمليات...
    }
    // باقي المستويات...
  }
};

// دمج مع القواعد الموجودة
Object.assign(accessRules, newResourceRules);
```

### تخصيص قواعد التفويض
```typescript
// يمكن تعديل القواعد في ملف dataLevelAuthorization.ts
// حسب احتياجات المؤسسة المحددة

// مثال: السماح للمديرين بكل شيء
if (user.role === 'مدير') {
  return { allowed: true, reason: 'صلاحيات إدارية كاملة' };
}
```

## أفضل الممارسات

### 1. فحص الصلاحيات دائماً
- لا تعرض أي بيانات بدون فحص الصلاحيات أولاً
- استخدم `checkAccess` قبل كل عملية

### 2. إخفاء الأزرار غير المتاحة
- أخفِ أزرار العمليات التي لا يملك المستخدم صلاحية لها
- اعرض رسائل واضحة عند منع الوصول

### 3. تسجيل جميع المحاولات
- سجل المحاولات الناجحة والفاشلة
- استخدم السجلات لمراقبة النشاط المشبوه

### 4. مراجعة الصلاحيات دورياً
- راجع قواعد التفويض بانتظام
- تأكد من أن الصلاحيات لا تزال مناسبة

### 5. اختبار السيناريوهات المختلفة
- اختبر بحسابات مختلفة (مدير، موظف، أقسام مختلفة)
- تأكد من عمل النظام في جميع الحالات

## استكشاف الأخطاء

### المشاكل الشائعة

#### 1. "Access Denied" غير متوقع
- تحقق من تصنيف البيانات
- تأكد من أن المستخدم في القسم الصحيح
- راجع قواعد التفويض للموارد

#### 2. عدم ظهور بيانات
- تحقق من أن `filterReadableData` يعمل بشكل صحيح
- تأكد من وجود بيانات مصنفة بالمستوى المناسب

#### 3. مشاكل في السجلات
- تحقق من localStorage للسجلات
- تأكد من أن `logDataAccess` يُستدعى في المكان المناسب

#### 4. بطء في الأداء
- استخدم `useMemo` لنتائج التصفية
- فكر في تخزين النتائج مؤقتاً للاستعلامات المتكررة

### التصحيح
```typescript
// تفعيل وضع التصحيح
localStorage.setItem('debugDataAuth', 'true');

// سيُظهر النظام معلومات إضافية في console
```

## الأمان والاعتبارات

### 1. عدم الاعتماد على الأمان من جهة العميل فقط
- هذا النظام للواجهة الأمامية فقط
- يجب تطبيق نفس القواعد في الخادم

### 2. تشفير البيانات الحساسة
- البيانات السرية يجب تشفيرها في التخزين
- استخدم HTTPS دائماً للنقل

### 3. مراجعة السجلات
- راقب محاولات الوصول غير المصرح بها
- ضع تنبيهات للأنشطة المشبوهة

### 4. تحديث الصلاحيات
- احذف الصلاحيات فوراً عند انتهاء الحاجة إليها
- راجع صلاحيات الموظفين عند تغيير المناصب

## المراجع والموارد

### الوثائق التقنية
- [RFC 3552 - Guidelines for Writing RFC Text on Security Considerations](https://tools.ietf.org/rfc/rfc3552.txt)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)

### أدلة الأمان
- دليل الأمان السيبراني للقطاع الحكومي السوري
- معايير الأمان للبيانات الحكومية

### الدعم التقني
لأي استفسارات أو مشاكل:
1. راجع هذا الدليل أولاً
2. تحقق من السجلات في localStorage
3. اتصل بفريق التطوير

---

**تاريخ آخر تحديث**: يناير 2025  
**الإصدار**: 1.0  
**المطور**: نظام الاستعلامات والشكاوى - مديرية مالية حلب